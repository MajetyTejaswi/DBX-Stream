name: Trigger Databricks Job

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}

jobs:
  trigger-job:
    name: Trigger Databricks Streaming Job
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          databricks --version
      
      - name: Trigger Databricks Job
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          JOB_ID="${{ secrets.DATABRICKS_JOB_ID }}"
          
          if [ -z "$JOB_ID" ]; then
            echo "❌ Error: DATABRICKS_JOB_ID secret is not set"
            echo "Please add your Databricks Job ID to GitHub Secrets"
            echo "Go to: Settings → Secrets and variables → Actions → New repository secret"
            exit 1
          fi
          
          echo "Triggering Databricks job ID: $JOB_ID"
          databricks jobs run-now $JOB_ID
      
      - name: Notify Success
        if: success()
        run: |
          echo "✅ Successfully triggered Databricks job!"
          echo "Check job status at: ${{ secrets.DATABRICKS_HOST }}/#job/YOUR_JOB_ID"
